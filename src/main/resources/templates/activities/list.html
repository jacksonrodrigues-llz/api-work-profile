<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <title>Atividades - Portal Profissional</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Dark Theme -->
    <link href="/css/dark-theme.css" rel="stylesheet">
    
    <style>
        .kanban-board {
            min-height: 85vh;
        }
        .kanban-column {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            height: 80vh;
            min-width: 280px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .kanban-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 8px 8px 0 0;
        }
        .kanban-cards {
            padding: 0.5rem;
            flex: 1;
            overflow-y: auto;
        }
        .kanban-cards.drag-over {
            background: rgba(255, 107, 53, 0.15) !important;
            border: 2px dashed #ff6b35 !important;
            border-radius: 8px;
        }
        .kanban-column.drag-over .kanban-cards {
            background: rgba(255, 107, 53, 0.15) !important;
            border: 2px dashed #ff6b35 !important;
        }
        .task-type-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            flex-shrink: 0;
        }
        .task-type-core {
            background: #28a745;
            color: white;
        }
        .task-type-bug {
            background: #dc3545;
            color: white;
        }
        .task-type-analysis {
            background: #17a2b8;
            color: white;
        }
        .kanban-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
        }
        .kanban-card .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        .kanban-card .card-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }
        .card-header-small {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .task-link {
            color: var(--accent-orange);
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .task-link:hover {
            text-decoration: underline;
        }
        .card-footer-small {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .priority-badge {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Cores para bordas dos cards */
        .priority-urgent { border-left: 4px solid #dc3545; }
        .priority-high { border-left: 4px solid #ffc107; }
        .priority-medium { border-left: 4px solid #17a2b8; }
        .priority-low { border-left: 4px solid #28a745; }
        
        /* Cores para badges de prioridade */
        .priority-urgent-badge { background-color: #dc3545 !important; color: white !important; }
        .priority-high-badge { background-color: #ffc107 !important; color: black !important; }
        .priority-medium-badge { background-color: #17a2b8 !important; color: white !important; }
        .priority-low-badge { background-color: #28a745 !important; color: white !important; }

        /* Cores para badges de prioridade */
        .priority-urgent-badge { background-color: #dc3545 !important; color: white !important; }
        .priority-high-badge { background-color: #ffc107 !important; color: black !important; }
        .priority-medium-badge { background-color: #17a2b8 !important; color: white !important; }
        .priority-low-badge { background-color: #28a745 !important; color: white !important; }
        .kanban-cards::-webkit-scrollbar {
            width: 4px;
        }
        .kanban-cards::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        .kanban-cards::-webkit-scrollbar-thumb {
            background: var(--accent-orange);
            border-radius: 2px;
        }
        .kanban-column-wrapper {
            transition: all 0.3s ease;
        }
        .kanban-column-wrapper.drag-over {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
            border: 2px solid #ff6b35;
            border-radius: 8px;
        }
        .column-actions {
            transition: opacity 0.3s ease;
        }
        .column-drag-handle {
            cursor: move;
        }
        .column-name {
            cursor: pointer;
        }
        .kanban-card {
            cursor: grab;
        }
        .kanban-card:active {
            cursor: grabbing;
        }
        .kanban-column-wrapper[draggable="true"] {
            cursor: move;
        }
        .kanban-column-wrapper[draggable="true"]:active {
            cursor: grabbing;
        }
        .kanban-cards {
            position: relative;
        }

    </style>
</head>
<body>
    
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <button class="navbar-toggler me-2" type="button" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            
            <a class="logo" href="/dashboard">
                <i class="fas fa-code me-2"></i>DevPortal
            </a>
            
            <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <img th:src="${user?.profilePhoto ?: (user?.avatar ?: 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + (user?.name ?: 'default'))}" alt="Avatar" class="rounded-circle me-2" width="24" height="24">
                        <span th:text="${user?.name ?: 'Usuário'}">Usuário</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="/profile"><i class="fas fa-user-edit me-2"></i>Perfil</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="sidebar">
                <div class="pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/dashboard">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/tech-debts">
                                <i class="fas fa-exclamation-triangle me-2"></i>Débitos Técnicos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white active" href="/activities">
                                <i class="fas fa-tasks me-2"></i>Atividades
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/goals">
                                <i class="fas fa-bullseye me-2"></i>Metas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/achievements">
                                <i class="fas fa-trophy me-2"></i>Conquistas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/daily-reports">
                                <i class="fas fa-calendar-week me-2"></i>Daily Reports
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/reports">
                                <i class="fas fa-chart-bar me-2"></i>Relatórios
                            </a>
                        </li>
                        <li class="nav-item" th:if="${user?.role?.name() == 'ADMIN'}">
                            <a class="nav-link text-white" href="/admin/users">
                                <i class="fas fa-users-cog me-2"></i>Gestão de Usuários
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="main-content px-4">
                <div class="pt-3 pb-2 mb-3 border-bottom d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2"><i class="fas fa-tasks me-3" style="color: var(--accent-orange);"></i>Atividades</h1>
                        <p class="text-muted">Gerencie suas tarefas e projetos</p>
                    </div>
                    <div>
                        <button id="refreshBtn" class="btn btn-outline-light me-2" onclick="refreshActivities()" title="Atualizar">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <a href="/activities/new" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Nova Atividade
                        </a>
                    </div>
                </div>

                <!-- Column Management -->
                <div class="mb-3 d-flex align-items-center">
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="showColumnModal()">
                        <i class="fas fa-plus me-1"></i>Nova Coluna
                    </button>
                    <button id="editColumnsBtn" class="btn btn-outline-secondary btn-sm me-2" onclick="toggleColumnEdit()">
                        <i class="fas fa-edit me-1"></i>Editar Colunas
                    </button>
                    <button id="saveColumnsBtn" class="btn btn-success btn-sm me-2 d-none" onclick="saveColumnPositions()">
                        <i class="fas fa-save me-1"></i>Salvar Posições
                    </button>
                    <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#helpModal">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>

                <!-- Kanban Board -->
                <div th:if="${activities.empty}" class="text-center py-5">
                    <i class="fas fa-tasks fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">Nenhuma atividade encontrada</h4>
                    <p class="text-muted">Configure seu board antes de adicionar atividades</p>
                    <button class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#setupModal">
                        <i class="fas fa-info-circle me-2"></i>Como Começar
                    </button>
                    <a href="/activities/new" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Criar Primeira Atividade
                    </a>
                </div>
                
                <div th:unless="${activities.empty}" class="kanban-board">
                    <div id="kanban-container" class="row g-2 flex-nowrap" style="overflow-x: auto;">
                        <div th:each="column : ${columns}" class="col kanban-column-wrapper" th:data-column-id="${column.id}">
                            <div class="kanban-column" ondragover="handleColumnDragOver(event)" ondrop="handleColumnDrop(event)">
                                <div class="kanban-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 column-title" th:data-column-id="${column.id}">
                                            <i th:class="${column.iconClass} + ' me-2'"></i>
                                            <span class="column-name" th:text="${column.name}">Column</span>
                                        </h6>
                                        <div class="column-actions d-none">
                                            <button class="btn btn-sm btn-outline-light me-1" th:onclick="'moveColumnLeft(' + ${column.id} + ')'" title="Mover para Esquerda">
                                                <i class="fas fa-arrow-left"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-light me-1" th:onclick="'moveColumnRight(' + ${column.id} + ')'" title="Mover para Direita">
                                                <i class="fas fa-arrow-right"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-light me-1" th:onclick="'editColumn(' + ${column.id} + ')'" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button th:if="${column.deletable}" class="btn btn-sm btn-outline-danger" th:onclick="'deleteColumn(' + ${column.id} + ')'" title="Excluir">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="kanban-cards" th:data-status="${column.status}">
                                    <div th:each="activity : ${activities}" th:if="${activity.status == column.status}" 
                                         class="kanban-card" 
                                         th:classappend="'priority-' + ${#strings.toLowerCase(activity.priority)}"
                                         th:data-id="${activity.id}"
                                         draggable="true"
                                         style="border-left-width: 4px;"
                                         onclick="showActivityModal(this)">
                                        <div class="card-header-small">
                                            <div class="d-flex align-items-center">
                                                <span class="task-type-indicator me-2"
                                                      th:classappend="${activity.taskType?.name() == 'CORE'} ? 'task-type-core' : (${activity.taskType?.name() == 'BUG'} ? 'task-type-bug' : 'task-type-analysis')"
                                                      th:title="${activity.taskType?.name() == 'CORE'} ? 'Core - Negócio' : (${activity.taskType?.name() == 'BUG'} ? 'Bug - Correção' : 'Análise - Investigação')">
                                                    <i th:class="${activity.taskType?.name() == 'CORE'} ? 'fas fa-briefcase' : (${activity.taskType?.name() == 'BUG'} ? 'fas fa-bug' : 'fas fa-search')"></i>
                                                </span>
                                                <div th:if="${activity.taskNumber}">
                                                    <a th:if="${activity.taskUrl}" th:href="${activity.taskUrl}" th:text="${activity.taskNumber}" class="task-link" target="_blank">Task</a>
                                                    <span th:unless="${activity.taskUrl}" th:text="${activity.taskNumber}" class="task-link">Task</span>
                                                </div>
                                            </div>
                                            <span class="badge priority-badge"
                                                  th:classappend="${activity.priority.toString() == 'URGENT'} ? 'priority-urgent-badge' : 
                                                                  (${activity.priority.toString() == 'HIGH'} ? 'priority-high-badge' : 
                                                                  (${activity.priority.toString() == 'MEDIUM'} ? 'priority-medium-badge' : 'priority-low-badge'))"
                                                  th:text="${activity.priority}">Priority</span>
                                        </div>
                                        <h6 class="card-title" th:text="${activity.title}">Title</h6>
                                        <p class="card-text" th:text="${#strings.abbreviate(activity.description, 60)}">Description</p>
                                        <div class="card-footer-small">
                                            <small class="text-muted" th:if="${activity.project}" th:text="${activity.project}">Project</small>
                                            <div class="drag-handle">
                                                <i class="fas fa-grip-vertical text-muted"></i>
                                            </div>
                                        </div>
                                        <div class="d-none">
                                            <span class="full-description" th:text="${activity.description}"></span>
                                            <span class="full-priority" th:text="${activity.priority}"></span>
                                            <span class="estimated-hours" th:text="${activity.estimatedHours}"></span>
                                            <span class="actual-hours" th:text="${activity.actualHours}"></span>
                                            <span class="skills" th:text="${activity.skills}"></span>
                                            <span class="task-number" th:text="${activity.taskNumber}"></span>
                                            <span class="task-url" th:text="${activity.taskUrl}"></span>
                                            <span class="edit-url" th:text="@{/activities/{id}/edit(id=${activity.id})}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Pré-visualização Atividade -->
    <div class="modal fade" id="activityModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                <div class="modal-header" style="background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title" id="modalTitle" style="color: var(--text-primary);">Atividade</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="color: var(--text-primary);">
                    <div class="row">
                        <div class="col-md-8">
                            <p id="modalDescription" style="color: var(--text-secondary);">Descrição</p>
                            <div class="mb-2">
                                <strong style="color: var(--accent-orange);">Projeto:</strong> <span id="modalProject">-</span>
                            </div>
                            <div class="mb-2" id="modalSkillsDiv">
                                <strong style="color: var(--accent-orange);">Habilidades:</strong> <span id="modalSkills">-</span>
                            </div>
                            <div class="mb-2" id="modalTaskNumberDiv">
                                <strong style="color: var(--accent-orange);">Número da Tarefa:</strong> <span id="modalTaskNumber">-</span>
                            </div>
                            <div class="mb-2" id="modalTaskUrlDiv">
                                <strong style="color: var(--accent-orange);">URL da Tarefa:</strong> <a id="modalTaskUrl" href="#" target="_blank">-</a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <strong style="color: var(--accent-orange);">Prioridade:</strong> <span id="modalPriority" class="badge">-</span>
                            </div>
                            <div class="mb-2" id="modalEstimatedDiv">
                                <strong style="color: var(--accent-orange);">Horas Estimadas:</strong> <span id="modalEstimated">-</span>
                            </div>
                            <div class="mb-2" id="modalActualDiv">
                                <strong style="color: var(--accent-orange);">Horas Reais:</strong> <span id="modalActual">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Fechar</button>
                    <a id="modalEditBtn" href="#" class="btn btn-primary">Editar</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gerenciar Coluna -->
    <div class="modal fade" id="columnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                <div class="modal-header" style="background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title" style="color: var(--text-primary);">Gerenciar Coluna</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="color: var(--text-primary);">
                    <form id="columnForm">
                        <input type="hidden" id="columnId">
                        <div class="mb-3">
                            <label for="columnName" class="form-label">Nome da Coluna *</label>
                            <input type="text" class="form-control" id="columnName" placeholder="Ex: Em Revisão" required>
                            <div class="form-text">Nome que aparecerá no cabeçalho da coluna</div>
                        </div>
                        <div class="mb-3">
                            <label for="columnStatus" class="form-label">Status (Identificador) *</label>
                            <input type="text" class="form-control" id="columnStatus" placeholder="Ex: REVIEW" required>
                            <div class="form-text">Identificador único (sem espaços, maiúsculo)</div>
                        </div>
                        <div class="mb-3">
                            <label for="columnIcon" class="form-label">Ícone</label>
                            <select class="form-select" id="columnIcon">
                                <option value="fas fa-circle text-primary">🔵 Azul</option>
                                <option value="fas fa-circle text-success">🟢 Verde</option>
                                <option value="fas fa-circle text-warning">🟡 Amarelo</option>
                                <option value="fas fa-circle text-danger">🔴 Vermelho</option>
                                <option value="fas fa-circle text-info">🔵 Ciano</option>
                                <option value="fas fa-circle text-secondary">⚫ Cinza</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="columnColor" class="form-label">Cor do Badge</label>
                            <select class="form-select" id="columnColor">
                                <option value="bg-primary">Azul</option>
                                <option value="bg-success">Verde</option>
                                <option value="bg-warning">Amarelo</option>
                                <option value="bg-danger">Vermelho</option>
                                <option value="bg-info">Ciano</option>
                                <option value="bg-secondary">Cinza</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveColumn()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                <div class="modal-header" style="background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title" style="color: var(--text-primary);">Como Usar o Kanban</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="color: var(--text-primary);">
                    <h6 style="color: var(--accent-orange);">Arrastar Atividades</h6>
                    <p>Clique e arraste os cards de atividades entre as colunas para alterar seu status automaticamente.</p>
                    
                    <h6 style="color: var(--accent-orange);">Gerenciar Colunas</h6>
                    <ul>
                        <li><strong>Nova Coluna:</strong> Cria uma nova coluna personalizada</li>
                        <li><strong>Editar Colunas:</strong> Ativa o modo de edição para modificar/excluir colunas</li>
                        <li><strong>Arrastar Colunas:</strong> No modo de edição, arraste colunas para reordenar</li>
                    </ul>
                    
                    <h6 style="color: var(--accent-orange);">Criar Coluna</h6>
                    <p>Preencha apenas o <strong>Nome</strong> e <strong>Status</strong>. Os outros campos têm valores padrão.</p>
                    <ul>
                        <li><strong>Nome:</strong> Como aparecerá na coluna (ex: "Em Revisão")</li>
                        <li><strong>Status:</strong> Identificador único (ex: "REVIEW")</li>
                    </ul>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Importante:</strong> Colunas só podem ser excluídas se estiverem vazias.
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Setup -->
    <div class="modal fade" id="setupModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
                <div class="modal-header" style="background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title" style="color: var(--text-primary);">
                        <i class="fas fa-rocket me-2" style="color: var(--accent-orange);"></i>Como Começar com o Kanban
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="color: var(--text-primary);">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 style="color: var(--accent-orange);"><i class="fas fa-magic me-2"></i>1. Colunas Automáticas</h6>
                            <p class="text-muted">Ao criar sua primeira atividade, o sistema automaticamente cria 8 colunas padrão:</p>
                            <ul class="text-muted small">
                                <li><strong>A FAZER</strong> - Tarefas pendentes</li>
                                <li><strong>EM PROGRESSO</strong> - Em desenvolvimento</li>
                                <li><strong>DEV</strong> - Ambiente de desenvolvimento</li>
                                <li><strong>UAT</strong> - Testes de usuário</li>
                                <li><strong>HML</strong> - Homologação</li>
                                <li><strong>PRD</strong> - Produção</li>
                                <li><strong>DEPLOY</strong> - Implantação</li>
                                <li><strong>CONCLUÍDO</strong> - Finalizado</li>
                            </ul>
                            
                            <h6 style="color: var(--accent-orange);"><i class="fas fa-tasks me-2"></i>2. Crie Atividades</h6>
                            <p class="text-muted">Comece adicionando suas atividades:</p>
                            <ul class="text-muted">
                                <li>Clique em "Nova Atividade"</li>
                                <li>Preencha título e descrição</li>
                                <li>Defina prioridade e projeto</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 style="color: var(--accent-orange);"><i class="fas fa-cogs me-2"></i>3. Personalize Colunas</h6>
                            <p class="text-muted">Depois pode personalizar seu board:</p>
                            <ul class="text-muted">
                                <li>Adicione novas colunas personalizadas</li>
                                <li>Remova colunas desnecessárias</li>
                                <li>Reordene conforme seu fluxo</li>
                            </ul>
                            
                            <h6 style="color: var(--accent-orange);"><i class="fas fa-arrows-alt me-2"></i>4. Organize o Fluxo</h6>
                            <p class="text-muted">Use drag & drop para mover atividades:</p>
                            <ul class="text-muted">
                                <li>Arraste cards entre colunas</li>
                                <li>Status atualizado automaticamente</li>
                                <li>Data de conclusão automática</li>
                            </ul>
                            
                            <div class="alert alert-success">
                                <i class="fas fa-rocket me-2"></i>
                                <strong>Pronto para começar!</strong> Crie sua primeira atividade e o board será configurado automaticamente.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Entendi</button>
                    <button type="button" class="btn btn-primary" onclick="showColumnModal()" data-bs-dismiss="modal">
                        <i class="fas fa-plus me-2"></i>Criar Primeira Coluna
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js"></script>
    
    <script>
        // Modal functionality
        function showActivityModal(card) {
            if (card.getAttribute('data-dragging') === 'true') {
                return;
            }
            event.stopPropagation();
            
            const title = card.querySelector('.card-title').textContent;
            const description = card.querySelector('.full-description') ? card.querySelector('.full-description').textContent : card.querySelector('.card-text').textContent;
            const project = card.querySelector('.card-footer-small .text-muted') ? card.querySelector('.card-footer-small .text-muted').textContent : '-';
            const priorityElement = card.querySelector('.priority-badge');
            const priority = priorityElement ? priorityElement.textContent : '-';
            const estimatedHours = card.querySelector('.estimated-hours') ? card.querySelector('.estimated-hours').textContent : '';
            const actualHours = card.querySelector('.actual-hours') ? card.querySelector('.actual-hours').textContent : '';
            const skills = card.querySelector('.skills') ? card.querySelector('.skills').textContent : '';
            const taskNumber = card.querySelector('.task-number') ? card.querySelector('.task-number').textContent : '';
            const taskUrl = card.querySelector('.task-url') ? card.querySelector('.task-url').textContent : '';
            const editUrl = card.querySelector('.edit-url') ? card.querySelector('.edit-url').textContent : '';
            
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalDescription').textContent = description;
            document.getElementById('modalProject').textContent = project;
            // Get priority from hidden span
            const prioritySpan = card.querySelector('.full-priority');
            const actualPriority = prioritySpan ? prioritySpan.textContent : (priority.replace('#', '').toUpperCase());
            
            document.getElementById('modalPriority').textContent = actualPriority;
            const priorityBadgeClass = actualPriority === 'URGENT' ? 'priority-urgent-badge' : 
                                     actualPriority === 'HIGH' ? 'priority-high-badge' : 
                                     actualPriority === 'MEDIUM' ? 'priority-medium-badge' : 'priority-low-badge';
            document.getElementById('modalPriority').className = 'badge priority-badge ' + priorityBadgeClass;
            
            const estHours = estimatedHours && estimatedHours !== 'null' && estimatedHours !== '' ? estimatedHours + 'h' : '-';
            const actHours = actualHours && actualHours !== 'null' && actualHours !== '' ? actualHours + 'h' : '-';
            const skillsText = skills && skills !== 'null' && skills !== '' ? skills : '-';
            const taskNumberText = taskNumber && taskNumber !== 'null' && taskNumber !== '' ? taskNumber : '-';
            const taskUrlText = taskUrl && taskUrl !== 'null' && taskUrl !== '' ? taskUrl : '';
            
            document.getElementById('modalEstimated').textContent = estHours;
            document.getElementById('modalActual').textContent = actHours;
            document.getElementById('modalSkills').textContent = skillsText;
            document.getElementById('modalTaskNumber').textContent = taskNumberText;
            
            if (taskUrlText) {
                document.getElementById('modalTaskUrl').textContent = taskUrlText;
                document.getElementById('modalTaskUrl').href = taskUrlText;
            } else {
                document.getElementById('modalTaskUrl').textContent = '-';
                document.getElementById('modalTaskUrl').href = '#';
            }
            
            document.getElementById('modalEditBtn').href = editUrl;
            
            // Hide empty fields
            document.getElementById('modalSkillsDiv').style.display = skillsText === '-' ? 'none' : 'block';
            document.getElementById('modalEstimatedDiv').style.display = estHours === '-' ? 'none' : 'block';
            document.getElementById('modalActualDiv').style.display = actHours === '-' ? 'none' : 'block';
            document.getElementById('modalTaskNumberDiv').style.display = taskNumberText === '-' ? 'none' : 'block';
            document.getElementById('modalTaskUrlDiv').style.display = !taskUrlText ? 'none' : 'block';
            
            new bootstrap.Modal(document.getElementById('activityModal')).show();
        }
        
        // Global variables
        let draggedCard = null;
        let draggedColumn = null;
        let editMode = false;
        
        // Card Drag and Drop
        document.addEventListener('dragstart', function(e) {
            if (e.target.classList.contains('kanban-card')) {
                draggedCard = e.target;
                e.target.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'move';
                e.target.setAttribute('data-dragging', 'true');
            }
        });
        
        document.addEventListener('dragend', function(e) {
            if (draggedCard) {
                draggedCard.style.opacity = '1';
                setTimeout(() => draggedCard.removeAttribute('data-dragging'), 100);
                draggedCard = null;
            }
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        });
        
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            if (draggedCard) {
                // Try multiple selectors for better drop zone detection
                const dropZone = e.target.closest('.kanban-cards') || 
                                e.target.closest('.kanban-column')?.querySelector('.kanban-cards');
                                
                if (dropZone && dropZone !== draggedCard.parentElement) {
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    dropZone.classList.add('drag-over');
                }
            }
        });
        
        document.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            
            if (draggedCard) {
                // Better drop zone detection
                const dropZone = e.target.closest('.kanban-cards') || 
                                e.target.closest('.kanban-column')?.querySelector('.kanban-cards');
                                
                if (dropZone && dropZone !== draggedCard.parentElement) {
                    const newStatus = dropZone.dataset.status;
                    const activityId = draggedCard.dataset.id;
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                    
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    if (csrfToken && csrfHeader) {
                        headers[csrfHeader] = csrfToken;
                    }
                    
                    // Move card immediately for better UX
                    dropZone.appendChild(draggedCard);
                    
                    // Update backend silently
                    fetch(`/activities/${activityId}/status`, {
                        method: 'PATCH',
                        headers: headers,
                        body: JSON.stringify({ status: newStatus })
                    })
                    .then(response => {
                        if (response.ok || response.status === 200) {
                            console.log('Card moved successfully');
                        } else {
                            console.warn('Backend update failed, but card moved visually');
                        }
                    })
                    .catch(error => {
                        console.warn('Network error, but card moved visually:', error);
                    });
                }
            }
        });
        
        // Column Management
        function toggleColumnEdit() {
            editMode = !editMode;
            document.querySelectorAll('.column-actions').forEach(el => {
                el.classList.toggle('d-none', !editMode);
            });
            
            const editBtn = document.getElementById('editColumnsBtn');
            const saveBtn = document.getElementById('saveColumnsBtn');
            
            if (editMode) {
                editBtn.innerHTML = '<i class="fas fa-times me-1"></i>Cancelar';
                editBtn.className = 'btn btn-outline-danger btn-sm me-2';
                saveBtn.classList.remove('d-none');
            } else {
                editBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Editar Colunas';
                editBtn.className = 'btn btn-outline-secondary btn-sm me-2';
                saveBtn.classList.add('d-none');
            }
        }
        
        function saveColumnPositions() {
            updateColumnPositions();
            editMode = false;
            document.querySelectorAll('.column-actions').forEach(el => {
                el.classList.add('d-none');
            });
            
            const editBtn = document.getElementById('editColumnsBtn');
            const saveBtn = document.getElementById('saveColumnsBtn');
            
            editBtn.innerHTML = '<i class="fas fa-edit me-1"></i>Editar Colunas';
            editBtn.className = 'btn btn-outline-secondary btn-sm me-2';
            saveBtn.classList.add('d-none');
            
            alert('Posições das colunas salvas com sucesso!');
        }
        
        function showColumnModal(columnId = null) {
            document.getElementById('columnId').value = columnId || '';
            
            if (columnId) {
                const column = document.querySelector(`[data-column-id="${columnId}"]`);
                if (column) {
                    document.getElementById('columnName').value = column.querySelector('.column-name').textContent;
                    document.getElementById('columnStatus').value = column.closest('.kanban-column-wrapper').querySelector('.kanban-cards').dataset.status;
                }
            } else {
                document.getElementById('columnName').value = '';
                document.getElementById('columnStatus').value = '';
                document.getElementById('columnIcon').value = 'fas fa-circle text-primary';
                document.getElementById('columnColor').value = 'bg-primary';
            }
            
            new bootstrap.Modal(document.getElementById('columnModal')).show();
        }
        
        function editColumn(columnId) {
            showColumnModal(columnId);
        }
        
        function saveColumn() {
            const columnId = document.getElementById('columnId').value;
            const data = {
                name: document.getElementById('columnName').value,
                status: document.getElementById('columnStatus').value,
                iconClass: document.getElementById('columnIcon').value,
                colorClass: document.getElementById('columnColor').value
            };
            
            const url = columnId ? `/api/columns/${columnId}` : '/api/columns';
            const method = columnId ? 'PUT' : 'POST';
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
            
            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }
            
            fetch(url, {
                method: method,
                headers: headers,
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Erro ao salvar coluna');
                }
            });
        }
        
        function deleteColumn(columnId) {
            if (confirm('Tem certeza que deseja excluir esta coluna?')) {
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                
                const headers = {};
                if (csrfToken && csrfHeader) {
                    headers[csrfHeader] = csrfToken;
                }
                
                fetch(`/api/columns/${columnId}`, {
                    method: 'DELETE',
                    headers: headers
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        return response.json().then(data => {
                            alert(data.error || 'Erro ao excluir coluna');
                        });
                    }
                });
            }
        }
        
        function moveColumnLeft(columnId) {
            const column = document.querySelector(`[data-column-id="${columnId}"]`);
            const container = document.getElementById('kanban-container');
            const allColumns = Array.from(container.children);
            const currentIndex = allColumns.indexOf(column);
            
            if (currentIndex > 0) {
                container.insertBefore(column, allColumns[currentIndex - 1]);
                updateColumnPositions();
            }
        }
        
        function moveColumnRight(columnId) {
            const column = document.querySelector(`[data-column-id="${columnId}"]`);
            const container = document.getElementById('kanban-container');
            const allColumns = Array.from(container.children);
            const currentIndex = allColumns.indexOf(column);
            
            if (currentIndex < allColumns.length - 1) {
                container.insertBefore(column, allColumns[currentIndex + 2]);
                updateColumnPositions();
            }
        }
        
        function updateColumnPositions() {
            const container = document.getElementById('kanban-container');
            const columnIds = Array.from(container.children).map(col => col.dataset.columnId);
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
            
            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }
            
            fetch('/api/columns/positions', {
                method: 'PUT',
                headers: headers,
                body: JSON.stringify({ columnIds: columnIds })
            })
            .catch(error => console.error('Error updating column positions:', error));
        }
        
        // Função de contagem removida
        
        function refreshActivities() {
            location.reload();
        }
        
        // Column-specific drag handlers for better detection
        function handleColumnDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            if (draggedCard) {
                const dropZone = e.currentTarget.querySelector('.kanban-cards');
                if (dropZone && dropZone !== draggedCard.parentElement) {
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    dropZone.classList.add('drag-over');
                }
            }
        }
        
        function handleColumnDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (draggedCard) {
                const dropZone = e.currentTarget.querySelector('.kanban-cards');
                if (dropZone && dropZone !== draggedCard.parentElement) {
                    const newStatus = dropZone.dataset.status;
                    const activityId = draggedCard.dataset.id;
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                    
                    const headers = { 'Content-Type': 'application/json' };
                    if (csrfToken && csrfHeader) {
                        headers[csrfHeader] = csrfToken;
                    }
                    
                    // Move card immediately
                    dropZone.appendChild(draggedCard);
                    
                    // Update backend silently
                    fetch(`/activities/${activityId}/status`, {
                        method: 'PATCH',
                        headers: headers,
                        body: JSON.stringify({ status: newStatus })
                    })
                    .then(response => {
                        if (response.ok || response.status === 200) {
                            console.log('Card moved successfully');
                        } else {
                            console.warn('Backend update failed, but card moved visually');
                        }
                    })
                    .catch(error => {
                        console.warn('Network error, but card moved visually:', error);
                    });
                }
            }
            
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Inicialização removida
        });
    </script>
</body>
</html>